<!DOCTYPE html>
<html>
    <head>
  	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script src="/js/jquery.collapse.js"></script>
		<script type="text/javascript" src="/js/shCore.js"></script>
		<script type="text/javascript" src="/js/shBrushPython.js"></script>
		<script type="text/javascript" src="/js/shBrushSql.js"></script>
		<script type="text/javascript" src="/js/shBrushPlain.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      	
    <title>Generating Custom Music Recommendation Systems</title>
    <link rel="icon" type="image/png" href="/img/profile.png">
    <link rel="stylesheet" href="../style.css">
    <link href="/css/shCore.css" rel="stylesheet" type="text/css" />
		<link href="/css/shThemeDefault.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css">
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

		<link rel="favicon-144-precomposed"  href="/img/profile.png">
		<link rel="shortcut icon" href="/img/profile.png">

    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

    <script type="text/javascript" src="//use.typekit.net/sjt4iho.js"></script>
 		<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
      
      	<script src="../node_modules/chart.js/dist/Chart.js"></script>
		<script src="../js/jquery-1.11.0.js"></script>

		
      	<style> 
        /***** BASE STYLES *****/ 
        
        code {
      		  color: inherit;
      		  background-color: rgba(0, 0, 0, 0.04);
      		}
		 pre:not([class]) {
		    background-color: white;
		  }
        blockquote {
          font-size: 21px;  
          margin: 90px 0 90px 0; 
          font-family: proxima-nova,proxima-nova,'proxima nova','helvetica neue',helvetica,sans-serif
        }

        cite {
          display: block;
          text-align: right;
          margin-top: 15px;
        }

        .firstcharacter { 
          float: left; 
          font-size: 54px; 
          line-height: 60px;  
          padding-right: 7px;  
        }  

        .fa {
          cursor: pointer;
        }  

        /** Navigation **/ 
          .main-navigation, .nav-toggle  {
            display: none;
          }

          #desktopNav	{
            position: absolute;
            height: 100%;
            background-color: #233140;
            top: 0;
            left: 0;
            z-index: 9999;
            width: 230px;
          }

          #desktopNav.fixedElement {
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
          } 


        nav ul li a {
          font-family: proxima-nova,proxima-nova,'proxima nova','helvetica neue',helvetica,sans-serif;
          color: #E8E8E8;
          text-decoration: none;
          transition: color 0.3s;
          letter-spacing: 1px;
        } 

        nav ul li a:hover {
          color: #C7C7C7;
        } 

         .secondUL li {
            padding: 10px 10px 0 0;
          }

          .navHeadline {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600; 
            color: #4C91B8;
          }

        .navSection {
            margin-bottom: 20px;
          } 

          .nav-toggle {
            transform: translateY(-100%);
            overflow: hidden;
            height: 50px;
            background: rgba(29, 55, 69, 0.9);
            transition: transform 0.9s ease;
            color: #E9A857;
            font-size: 20px;
          } 

         #bootstrap-overrides  .nav-toggle.show {
            height: 50px;
            transform: translateY(0%);
            transition: transform 0.9s ease;
          }

         #bootstrap-overrides  .main-navigation {
            position: fixed;
            top: 0;
            left:0; 
            width: 270px;
            height: 100%;
            background: rgba(29, 55, 69, 0.9);
          }

        

        

        .center {
          max-width: 1170px;
          margin: 0 auto;
          position: relative;
        }
        .img-center{
          margin-left: 115px;
          margin-top: 40px;
          margin-bottom: 40px;
        }

        .wrapper {
          margin-left: 230px;
        } 	  
          
        .left {
          width: 50%;
          float:left;
        }

        .right {
          position: relative; 
          float:left;
          width: 50%;
        }  

        .introLetterDiv, .outroLetterDiv {
            background-color: #fff; 
            padding: 70px;  
            text-align: left; 
            max-width: 600px; 
            margin: 0 auto;
        }

        .introLetterDiv h3 {
            font-size: 21px;
            font-weight: 400;
            margin-bottom: 35px;
            margin-top: -20px;
        }

        .introLetterDiv .signature {
            text-align: right;
        } 

        .introLetterDiv .signatureBox {
            text-align: center;
            display: inline-block;
        } 

        .introLetterDiv p, .outroLetterDiv p {
          max-width: 600px;
          margin-left: 0;
        } 

        .main_title {
          text-align: center;
        }  

        .letterOrange {
          width: 85px; 
          height:7px; 
          display: block; 
          background-color: #E9A857; 
          margin:40px 0;" 
        } 

        .firstOrangeBar {
            background-color: #E9A857;
            display: block; 
            height: 254px; 
            width: 27px;
        }

        .headerThree h2 {
          margin-top: 30px;
          display: inline-block;
          width: 450px;
          vertical-align: top;
        }

        #three .thickOrangeLine {
          position: absolute;
          top: 160px;
        }

        .bulkUpImage {
          margin-left: 22%; 
        }

        .nasties {
           width: 60%;
           position: absolute;
           top: 50px;
        }

        .badHabbit {
          width: 300px;
          line-height: 94px;
          display: inline-block;
          margin-top: 0.83em;
        }  

        .thickOrangeLine { 
          width: 82px; 
          height: 27px; 
          background-color: #E9A857; 
          position: absolute;
          top: 50px;
        }

        .learnMobile {
            display: none;
        }

        

        /** Exeptions **/
        article#one {
            margin-bottom: 50px;
          	padding: 0;
        }
          
        article#two {
            padding-top: 0
        } 
          
        article#four h2 {
            margin-top:.5em;
        } 
          
        article#eight .quote {
            margin-top: 30px 0 75px 0;
        } 
          
        article#eight .center .left, article#six .center .left {
            margin-right: 5%;
        } 
          
        article#eight .right, article#six .right {
            width: 45%;
        }
          
        article#eight .right img, article#six .right img {
            width: 100%;
        }  

        /*** Footer ***/
          footer {
            background-color: #1D3745; 
            width: 100%; 
            position: absolute; 
            z-index: 9999; 
            bottom: -70px;
          } 
          
           footer p {
            float: left;
          }

          .mktoForm {
            width: auto!important;
          }

          .bulkUpImage {
          	width: 46%;
          }	
          
          /***** Desktop Small *****/
          @media screen and (max-width: 1441px) {

            .center {
                max-width: 970px;
            }

            .nasties {
              top: 165px;
              width: 60%;
            }

            .container .sideText1, .container .sideText2, .container .sideText3, .container .sideText4, .container .sideText5 {
              margin-left: 60px;
              margin-right: auto;
            }

            .container .sideText1 p, 
.container .sideText2 p, .container .sideText3 p, .container .sideText4 
p, .container .sideText5 p {
              margin-left: 0;
            }

            .thickOrangeLine {
              display: none;
              top: 30px;
              width: 43px;
            }

            .bulkUpImage {
              width: 65%;
            }
          }  

          @media screen and (max-width: 1225px) {
            .center {
              max-width: 870px;
            }

            .bulkUpImage {
              width: 78%;
            }
          }

          @media screen and (max-width: 1170px) {
            .center {
              max-width: 770px;
            }

            footer {
              display: none;
            }

            .bulkUpImage { 
              width: 100%;
              margin-left: 10%;
            }
          }   

          @media screen and (max-width: 1024px) {

            .learnDesktop {
              right: -155px
            }

            .center {
              max-width: 670px;
            }
          }  

        

          
        </style>


<style>.mktoGen.mktoImg {display:inline-block; line-height:0;}</style>
  	</head>
  	<body id="bootstrap-overrides">
<style type="text/css"> 
#bootstrap-overrides hr.star-light {  
  border-color: #18BC9C;
	margin-left: auto;
    margin-right: auto;}
 #bootstrap-overrides  hr.star-light:after {
background-color: white;
color: #2C3E50;}
canvas {
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
    width: 90px;
}
</style>
  	</body>
	<body class="layout" id="bodyId">
      	
		<div class="extraWrapper" style="position:relative;">	
			<!-- DESKTOP FIXED NAV -->
         	<div id="desktopNav">
            <div style="position: relative; height: 100%;">
               <nav>
                  <ul class="firstUL">	
                    <br>
                    <li class="navSection"><span class="navHeadline"><a style="color: #4C91B8;" href="/">Home</a></span>
                      <ul class="secondUL"> 
                          <li><a href="/#portfolio">Portfolio</a></li>
                          <li><a href="/blog/">Blog</a></li>
                      </ul>
                    </li>
                    <li class="navSection"><span class="navHeadline">Contents</span>
                      <ul class="secondUL">	
                          <li><a href="/examples/SmoothPageScroll/#one">Hypothesis</a></li>
                          <li><a href="/examples/SmoothPageScroll/#two">Getting Chords</a></li>
                          <li><a href="/examples/SmoothPageScroll/#three">Analyzing Chords</a></li>
                          <li><a href="/examples/SmoothPageScroll/#four">Getting Country Music Lyrics</a></li>
                          <li><a href="/examples/SmoothPageScroll/#five">Analyzing Lyrics</a></li>
                          <li><a href="/examples/SmoothPageScroll/#six">Generating Original Lyrics</a></li>
                          <!--<li><a href="/examples/SmoothPageScroll/#seven">Emailing Results and Scheduling the Model</a></li>-->
                          <li><a href="/examples/SmoothPageScroll/#eight">Conclusion</a></li>
                          <li><a href="/examples/SmoothPageScroll/#forecast">Other Projects</a></li>
                      </ul>
                    </li>

                  </ul> 
              </nav> 
            </div>
          	</div>
	<div class="wrapper" id="header">
<p><br></p>
<h1 align="center" style = "margin: 0;">Generating Custom Music Recommendation Systems</h1>
<header>
    <hr class="star-light">
</header>
</div>
          	<div class="wrapper">
				<!-- Resolution 1 -->
				<article id="one">
      				<div class="center">
              			<div>
              				<h2>Goal</h2>
                      <p>I hypothesize that all country music sounds the same because of <i>similiarities in the components of songs</i>. Specifically, because many country music songs are composed with vocals and guitar, the way the guitar is played and the kinds of lyrics used in the songs may be key components in determining whether or not all country music does sound similar. The way the guitar is played can be determined by the <a target="_blank" href = "https://en.wikipedia.org/wiki/Chord_progression">chord progression</a>, and I hypothesize that many country songs all use the same chord progession, whereas in other genres of music, there will be a greater variation of the chord progressions used in songs. I also suspect that the lyrics have some similarity in the words used and a <a target="_blank" href = "https://en.wikipedia.org/wiki/Naive_Bayes_classifier">naive-Bayes analysis</a> may be suitable.</p>
<p>The complete code can be found on github <a target="_blank" href="https://github.com/moocarme/Coding-Samples/tree/master/Python-Webscraping">here</a>.</p>
              			</div>
              			<div class="left"></div>
      				</div>  
    			</article>  
    			<!-- End Resolution 1 -->
    
				<!-- Resolution 2 -->
				<article id="two">  
          			
         	 			<div class="center">    
            				<h2>Method</h2>  
								<p>A chord progression is the different chords used in songs, as well as the order in which they are used. For example Pearl Jam's <a target="_blank" href = "https://www.youtube.com/watch?v=2z0cKtSlHOU">'Elderly woman...'</a> uses a chord progression D C G G for the much of the verse and chorus. Both the notes used and their respective order is needed. The assumption that the guitar plays the characteristic 'sound' of the song and can be infered from the data gained from the chord progression of the guitar.</p>  
                <p>A python webscraper mines guitar tabluture from the internet, specifically <a target="_blank" href="https://ultimate-guitar.com">ultimate-guitar.com</a> and reads them to obtain the chords used in songs. The python code retrives the chords that users of the site have entered. Because the guitar tablature is user submitted, only 5 star rated tablatures are used in standard tuning, for greatest accuracy. A 5 star rating is achieved when all users of the tablature rate the tab as 5-star. Mining the tablature for data on the various chord progressions played in songs, the end goal would be analyze different genres of music to show that country music shows less variation in the chords and chord progressions used compared to other genres of music.</p>
                <h3>Guitar tablature Example</h3>
<div data-collapse>
      <h4>See here &#9660;</h4>
 
    <div>

    <p>Below is an example of typical guitar tablature from ultimate-guitar.com</p>
    <pre class="brush: sql">Band- Metallica
Song- TuesdAYS gONE

  A5                   E5                   F#5                   D
      x 0 2 2 x x          0 2 2 x x x          2 4 4 x x x          x x 0 2 3 2

         Dsus4                Dsus2                  G                   F#m
      x x 0 2 3 3          x x 0 2 3 0          3 2 0 0 3 3          2 4 4 2 2 2

         GIII
      3 5 5 4 3 3

Gtr I (Eb Ab Db Gb Bb Eb) - 'acoustic'
Gtr II (Eb Ab Db Gb Bb Eb) - 'dobro'
Gtr III (Eb Ab Db Gb Bb Eb) - 'acoustic'
Gtr IV (Eb Ab Db Gb Bb Eb) - 'acoustic'

 Intro
  Slowly H.=50
                   A5                                 E5
 3/4
  Gtr I
                    |           |                      |    ||
                    /           /                      /    //

  Gtr II
                                                       ~~
|-------|-------||-----------|----------------------|------------|
|-------|-------||-14--------|-14------14b16r=(14)--|-12---------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|
| Gtr III
|                                                      ~~
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-11--------|-11b13r=(11)----------|--9---------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|----------------------|------------|
|
| Gtr IV
|-------|-------||-----------|----------------------|------------|
|-------|-------||-----------|--2-------------------|------------|
|-------|-------||--------2--|----------2-----------|------------|
|-------|-------||-----2-----|------------------2---|--------2---|
|-------|-------||--0--------|----------------------|-----2------|
|-------|-------||-----------|----------------------|--0---------|


                    F#5                                   D
  |        |  |      |         ||    |        |     |     |  | || |
  /        /  /      /         //    /        /     /     /  / // /

                        ~~~~~~~                           ~
|-----------------|----------------|--------------------|----------|
|----12b13r=(12)--|-12-10-(10)-----|----10b12r====(10)--|-7--------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|
|                    ~~                                   ~
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|-----9b10r==(9)--|--7-------------|----------7b9r=(7)--|-4--------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|----------|
|
|                    PM---------------------------|
|-----------------|----------------|--------------------|----------|
|-----------------|----------------|--------------------|-------3--|
|-1---------------|----------------|-2------------------|----2-----|
|-----2-----------|-------------4--|-----4--------------|-0--------|
|-------------2---|---------4------|----------------4---|----------|
|-----------------|--2-------------|--------------------|----------|

    </pre>
    </div>
  </div>
  <p><br></p>
  <p>The python webscraper built goes through all the tabs of a particular genre and grabs all the chords played in the song. The chord progression is obtained by simply finding the 4-chord combination that is most common. This chord progression is then added to an SQL database, along with the artist name, song title genre and subgenre. An example of sub-genre to a genre is bluegrass, which is a sub-genre to country. This relationship was taken from exploring how <a target="_blank" href="https://www.ultimate-guitar.com/">ultimate-guitar.com</a> specifies. Once database of all the chord progressions is obtained, a subsection can be queried from the list, i.e. accouding to subgenre, and it is sorted and plotted. A cumulative distribution is also obtained from the sorted list and is useful for determining global variation.</p>
  <p><br></p>
  <h3>Python script - Chords Webscraper</h3>
<div data-collapse>
      <h4> See here &#9660;</h4>
    <div>
    <pre class="brush: python"># -*- coding: utf-8 -*-
"""
Created on Sun Mar 20 12:12:07 2016
Updates on Sun Apr 17
Added SQL database on July 10th

@author: matt
"""
# = Import packages
import requests
from lxml import html
from lxml.etree import tostring
import sqlite3
import collections
import re

# = Helper Functions =========================================================

def removeTags(string):
    '''
    Function to remove html tags
    '''
    return re.sub('<[^<]+?>', '', string)
    
def getArtist(webTree):
    '''
    Function to get the artist name from html
    '''
    ArtistLoc = webTree.find_class('t_autor')
    ArtistStrList = [tostring(track, with_tail=False) for track in list(ArtistLoc[0].iter('a'))]
    Artist = removeTags(ArtistStrList[0])
    return Artist
    
def getTrack(webTree):
    '''
    Function to get the track name from html
    '''
    title = webTree.find_class('t_title')
    Tracklist = [tostring(track, with_tail = False) for track in list(title[0].iter('h1'))]
    Track = removeTags(Tracklist[0])
    return Track

def getChordsList(webTree):
    '''
    Function to get a list of chords from html
    '''
    tabContentClass = webTree.find_class('js-tab-content')
    try:
        chordsList = list(tabContentClass[0].iter('span')) # starts at element 0
        chords = [tostring(chord, with_tail = False).strip('</span>') for chord in chordsList]
    except IndexError:
        chords = []
    return chords
    
def getChordsArtistTrack(url):
    '''
    Function to get chords from a webpage in str format
    '''
    webPage = requests.get(url)
    webTree = html.fromstring(webPage.content)
    Artist = getArtist(webTree)
    Track = getTrack(webTree)
    Chords = getChordsList(webTree)    
    return Artist, Track, Chords 

def getGenreTree(genrekey, page):
    '''
    Function to get xml tree given the genre
    '''    
    if type(page) == int:
        page = str(page)
    theURL = 'https://www.ultimate-guitar.com/search.php?type[2]=300&type2[0]=40000&rating[4]=5' \
        + '\&tuning[standard]=standard&genres[0]=' + str(genrekey)+ '&page=' + page \
        + '&view_state=advanced&tab_type_group=text&app_name=ugt&order=myweight'
        
    pageBand = requests.get(theURL)
    return html.fromstring(pageBand.content)
    

def getChordProg(chordList, progLen = 4):
    '''
    Function to get the most common chord progression in a list
    '''
    progs4 = [''.join(chordList[i:i+progLen]) for i in range(len(chordList)-progLen)]
    try:
        chordProg = collections.Counter(progs4).most_common(1)[0][0]
    except IndexError: # If there are no chords
        chordProg = ''
    return chordProg
    
def getGenreDict():
    '''
    Function to get all the genres and output to a dict of dicts where the keys 
    to the outer dict is the main genre the values are dicts, with the inner
    values being the sub genre
    '''
    url = 'https://www.ultimate-guitar.com/advanced_search.html'
    pageUrl = requests.get(url)
    webTree = html.fromstring(pageUrl.content)
    Main = webTree.find_class('b')
    MainGenreList = list(Main[2].iter('optgroup'))
    GenreDict = {}
    for Genre in MainGenreList:
        GenreStr = tostring(Genre, with_tail = False)
        g1 = str.split(re.sub('&#13;\s+','\n',removeTags(GenreStr)),'\n')[1:-1]
        MainGenre = g1[0]
        GenreInd_complete = re.findall(r'\d+',GenreStr)
        if len(GenreInd_complete)>4:
            GenreInd = GenreInd_complete[2:-2:2]
        else:
            GenreInd = GenreInd_complete[2]
        subGenreDict = dict(zip(g1[1:], GenreInd[1:]))
        if bool(subGenreDict):
            GenreDict[MainGenre] = subGenreDict
        else:
            GenreDict[MainGenre] = dict([(MainGenre, GenreInd[0])])
    return GenreDict
# ============================================================================

def main()
    # = Set up SQL 
    conn = sqlite3.connect('chordProgdb2.sqlite')
    cur = conn.cursor()
    cur.executescript('''
    /*
    Uncomment out the bottom section is want to reset the tables
    */
  
    /*
    DROP TABLE IF EXISTS Artist;
    DROP TABLE IF EXISTS ChordProg;
    DROP TABLE IF EXISTS Genre;
    DROP TABLE IF EXISTS Song;
  
    CREATE TABLE Artist (
        id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
        name    TEXT UNIQUE
    );
  
    CREATE TABLE ChordProg (
        id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
        prog   TEXT UNIQUE
    );
  
    CREATE TABLE Genre (
        id  INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT UNIQUE,
        name    TEXT UNIQUE
    
    );

    CREATE TABLE Song (
        id  INTEGER NOT NULL PRIMARY KEY 
            AUTOINCREMENT UNIQUE,
        title TEXT,
        artist_id INTEGER,
        chordProg_id  INTEGER,
        genre_id INTEGER,
        subgenre_id INTEGER
    );
    */
    ''')

    # ============================================================================


    allGenresDict = getGenreDict()
    #to find all genres: allGenresDict.keys()
    
    mainGenre = 'Alternative'
    genresDict = allGenresDict[mainGenre]
    
    cur.execute('''INSERT OR IGNORE INTO Genre (name) 
        VALUES ( ? )''', (mainGenre, ) )
    cur.execute('SELECT id FROM Genre WHERE name = ? ', (mainGenre, ))
    main_genre_id = cur.fetchone()[0]   
    
    page = '1' # start at page 1, in str format as will be added to html str
    
    for genre, genrekey in genresDict.iteritems():
        # = Get xml tree for first page
        tree1 = getGenreTree(genrekey, page)
        pages = tree1.find_class('paging')
        try: 
            maxPage = len(list(pages[0].iter('a'))) # see what the max number of pages is
            print('Max Page: '+ str(maxPage))
        except IndexError:
            break
        # = Grab song links on the first page
        songs = tree1.find_class('song result-link')
        songLinks = []
        for i in songs:
            songLinks.append(i.get('href'))        
        
        # = Iterate through the remaining pages and add song links
        for i in range(maxPage -1):
            looppage = i + 2
            looptree = getGenreTree(genrekey, str(looppage))
            loopsongs = looptree.find_class('song result-link')
            for song in loopsongs:
                songLinks.append(song.get('href'))
        
        print('No of tabs: ' + str(len(songLinks)))
        
        cur.execute('''INSERT OR IGNORE INTO Genre (name) 
            VALUES ( ? )''', (genre, ) )
        cur.execute('SELECT id FROM Genre WHERE name = ? ', (genre, ))
        subgenre_id = cur.fetchone()[0]
             
        
        progLen = 4
        for i in songLinks:
            Artist, Song, Chords = getChordsArtistTrack(i)
            chordProg = getChordProg(Chords, progLen)
            
            cur.execute('''INSERT OR IGNORE INTO Artist (name) 
                VALUES ( ? )''', ( Artist, ) )
            cur.execute('SELECT id FROM Artist WHERE name = ? ', (Artist, ))
            artist_id = cur.fetchone()[0]    
            
            cur.execute('''INSERT OR IGNORE INTO ChordProg (prog) 
                VALUES ( ? )''', (chordProg, ) )
            cur.execute('SELECT id FROM ChordProg WHERE prog = ? ', (chordProg, ))
            chordProg_id = cur.fetchone()[0]
            
            cur.execute('''INSERT OR REPLACE INTO Song
                (title, artist_id, genre_id, subgenre_id, chordProg_id) 
                VALUES ( ?, ?, ?, ?, ? )''', 
                ( Song, artist_id, main_genre_id, subgenre_id, chordProg_id, ) )
            conn.commit()
        
if __name__=='__main__':
    main()</pre>
    </div>
  </div>
  <p><br></p>
  <h3>Database Entity Relationship Diagram</h3>
  <div data-collapse>
        <h4> See here &#9660;</h4>
    <div>
      <img class="img-responsive" src="../img/riffcode_figs/dbschema.png"  height="500" width="500">
    </div>
  </div>
  <p><br></p>
  <h3>SQL Query Example</h3>
  <h4>Accessing top 10 most frequent Americana chords</h4>
  <h4>Query</h4>
  <ul><li><p>Joins the appropriate tables in the database.</p></li></ul>
  <ul><li><p>Filter by subgenre.</p></li></ul>
  <ul><li><p>Group by chord progression.</p></li></ul>
  <ul><li><p>Order by their total count, descending.</p></li></ul>
  <ul><li><p>Select appropriate columns.</p></li></ul>
  <div data-collapse>
        <h4> See here &#9660;</h4>
    <div>
      <pre class = "brush: python"># -*- coding: utf-8 -*-
"""
Spyder Editor

Created on July 10th
"""

import sqlite3
conn = sqlite3.connect('chordProgdb2.sqlite')
cur = conn.cursor()

def main():
  cur.execute('''
  SELECT chord.prog, COUNT(*)
  FROM Song AS master
  LEFT JOIN Genre AS subgenre_tbl ON subgenre_tbl.id = master.subgenre_id
  LEFT JOIN Genre ON genre.id = master.genre_id
  LEFT JOIN ChordProg AS chord ON chord.id = master.chordProg_id
  WHERE subgenre_tbl.name = 'Americana'
  GROUP BY chord.prog
  ORDER BY COUNT(*) DESC
  LIMIT 10
  ;
  ''')

  top10Americana= cur.fetchall()
  conn.commit
  print(list(top10Americana))

if __name__=="__main__":
  main()

      </pre>
      <pre class="brush: plain">out: [(u'DGDG', 7), (u'CGAmC', 6), (u'GCGC', 6), (u'GEmGEm', 6), (u'B7EAE', 5), (u'CFCF', 5), 
(u'EEEE', 5), (u'DADA', 4), (u'DEmCG', 4), (u'DGCG', 4)]</pre>
    </div>
  </div>
  <p>Though the data is not very big in size it may be a good question to ask why the data is even in a SQL database in the first place, since the total data is only a few megabytes, and will easily fit in memory. My reason is that it is a good habit I have developed, to load, save, and access SQL tables in databases. Moreover, adding to the database can easily be done and is standaradized using the entity relationship diagram (ERD), data can be added from other data sources, and is the database can be incorporated to other projects easily. </p>
  <p><br></p>
            				<div class="left">
              					<div class="container">
                					<div class="sideText2">
                  						<span class="line"></span>
                  						<p></p>
                					</div>
              					</div>
              					
            				</div>   
         				</div>
         			  
      			</article>
      			<!-- End Resolution 2 -->
    
	  			<!-- Resolution 3 -->
	  			<article id="three" style="background-color:#f7f7f7;">
          			<div class="center">
          				<p><br></p>
        				<h2>Results</h2>
              				<p><br></p>
                <script>
                var myChart_chordProg = new Chart({...})
            </script>
            <canvas id="myChart_chordProg" width="60%" height="100%"></canvas>
            <script>

            var ctx = document.getElementById("myChart_chordProg");
            ctx.width = 200;
            ctx.height = 100;
            var randomColorFactor = function() {
                        return Math.round(Math.random() * 255);
                    };
            var randomColor = function() {
                        return 'rgba(' + randomColorFactor() + ',' + randomColorFactor() + ',' + randomColorFactor() + ',.7)';
                    };
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['GDCG', 'CGAmF', 'DCGD', 'CGDC', 'DAGD', 'CGCG', 'GDEmC', 'DGDG', 'DGDC', 'DAEmG', 'AmCGAm', 'GAmCG', 'GCGD', 'DABmG', 'GDAG', 'CGAmC', 'GAmFG', 'GFCG', 'EmCDG', 'DGDCadd9'],
                    datasets: [{
                        label: 'Count',
                        data: [319, 205, 193, 186, 180, 176, 175, 157, 147, 147, 131, 114, 109, 108, 106, 104, 98, 97, 96, 96],
                        backgroundColor: 'rgba(24, 188, 156, 0.6)',
                        borderColor: 'rgba(9, 74, 61, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                  title: {
                        display: true,
                        text: 'Top 20 Chord Progressions used in Country Music',
                        fontSize: 30
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            },
                            scaleLabel: {
                          display: true,
                          labelString: 'Count',
                          fontSize: 30
                        }
                        }],
                        xAxes: [{
                            scaleLabel: {
                          display: true,
                          labelString: 'Chord Progression',
                          fontSize: 30
                        }
                        }]
                    }
                }
            });
            </script>
            <p><br></p>
            <script>
                var myChart_chordProgcdf = new Chart({...})
            </script>
            <canvas id="myChart_chordProgcdf" width="800%" height="600px"></canvas>
            <script src = "../riffCode/chordProg_cdf.js"></script>
            <p><br></p>
            <p> <br> We can see that the many of the chord progressions used in country music include the chords G, C, and D. And notably the highest used chord proression, "GDCG", is used more than 50% more that the following most common chord porgression. However, if we look at the variation of chord progressions, seen in the cumulative distribution function, country music does not appear to show any less variation than other genres. </p>
            <p> If we look at the count of each chords, i.e., in all the songs count the total instance of particluar chords, this may tell us more. This can be done by aggregating and summing all the chords from all the tabs.<br></p>
            <p><br></p>
            <script>
                var myChart_chords = new Chart({...})
            </script>
            <canvas id="myChart_chords" width="150" height="150"></canvas>
            <script>
            var ctx = document.getElementById("myChart_chords");
            ctx.width = 200;
            ctx.height = 100;
            var randomColorFactor = function() {
                        return Math.round(Math.random() * 255);
                    };
            var randomColor = function() {
                        return 'rgba(' + randomColorFactor() + ',' + randomColorFactor() + ',' + randomColorFactor() + ',.7)';
                    };
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['G', 'C', 'D', 'A', 'F', 'Am', 'Em', 'E', 'Bm', 'B', 'Dm', 'Cadd9', 'Bb', 'F#m', 'C#m', 'D7', 'Em7', 'F#', 'A7', 'E7'],
                    datasets: [{
                        label: 'Usage (%)',
                        data: [19.339349908243044, 13.529751879132204, 13.388974081801955, 7.388320470600066, 6.083611956057216, 5.869931370823801, 5.26408406445612, 4.152945021242364, 2.1166947384298247, 2.089041956811383, 1.6868196787249552, 1.2292918374016442, 1.1815279418788809, 1.096055707785515, 0.9326529073129037, 0.9024862364564217, 0.7365695467457704, 0.5932778601774806, 0.5857361924633601, 0.5781945247492396],
                        backgroundColor: 'rgba(24, 188, 156, 0.6)',
                        borderColor: 'rgba(9, 74, 61, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                  title: {
                        display: true,
                        text: 'Top 20 Chords Used in Country Music',
                        fontSize: 30
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            },
                            scaleLabel: {
                          display: true,
                          labelString: 'Usage (%)',
                          fontSize: 30
                        }
                        }],
                        xAxes: [{
                            scaleLabel: {
                          display: true,
                          labelString: 'Chord',
                          fontSize: 30
                        }
                        }]
                    }
                }
            });
            </script>
            <p><br></p>
            <script>
                var myChart_chordcdf = new Chart({...})
            </script>
            <canvas id="myChart_chordcdf" width="800%" height="600px"></canvas>
            <script src = "../riffCode/chord_cdf.js"></script>
            <p><br></p>
            <p>
            We find that Chords involving variations of G, C, and D are very popular in country music and those three chords account for about 45% of the total chords, if we look at the top 8 chords (G, C, D, A, F, Am, Em, E) they account for almost 75%. For context there are over 800 various chord combinations (see: <a target="_blank" href = "https://tabs.ultimate-guitar.com/m/misc/all_the_chords_crd.htm">here</a>). So we can see how these 8 chords and their various combinations can lead to music that may sound similar. </p>
            <p>When we compare the variation to other genres we can see that country music stands out with little variation in the chords used. From the previous cumulative distribution function we found that the variation of chord progressions is on par with other genres, but from this cumulative distribution function we find that the variation in actual chords is small. <big><b><i>Country music uses the same chords in many different combinations</i></b></big>. This may explain why many country music songs sound similar.</p>
            <p><br></p>
            <h4>Discussion</h4>
            <p>
            One issue I came across when scraping the website is that ultimate-guitar.com only allows 500 search results, yet there are over 20,000 5-star rated chord tabs for some of the genres, separating by sub genre, or even by artist may lead to a greater number of tabs to be processed and so trends may become clearer. This 500 search limit is probably for the user expereince, since I'm assuming no one want to search manually through 20,000 results. 500 a happy medium that is small enough to search manually through, yet large enough to provide good and varied results in the search.</p>
            <hr>
            <ul><p><big><i>"Three chords and the truth - that's what a country song is"</i></big></p></ul>
            <ul><ul><p><big>- <a target="_blank" href="http://willienelson.com/">Willie Nelson</a></big></p></ul></ul>
            <hr>

            			<div class="left"> 
          				</div>   
       				</div>    
      			</article>
     			<!-- End Resolution 3 -->
      
    			<!-- Resolution 4 -->
    			<article id="four">
    				<div style="position: relative;">
      					<div class="center">  
          					
							<h2>Methods to Recommend Songs</h2>
							<p><br></p>
							<h3>Cosine Similarity</h3>
<p>When dealing with a large number of users and a large number of songs and find similarities between users or songs things can quickly get out of hand. For example, to calculate the song similarity between all songs we could go through each song and calculate its similarity with each other song, however that would involve nested for loops with <span class = "math">\(\frac{n(n-1)}{2} \)</span> operations. Since there are 149029 unique songs in the data set, this equates to 11104746906 operations. While this is highly parallelizable, for optimal use of resources, <b>we use linear algebra</b>.</p>
<p> To solve the similarity between users and songs we construct a sparse matrix, <span class = "math">\(R(i,j)\)</span>, that is <span class = "math">\(m\times n\)</span>, where <i>m</i> is the total number of users, and <i>n</i> is the total number of songs. The entry of the matrix for user <i>i</i> at song <i>j</i> represents the relative number of plays that of the song compared to the total number of songs the user listens to, i.e., is the user listens to a song 6 times out of listening to 60 songs total, the relative play would be 0.1. We use relative plays as it will make constructing the similarity matrices easier.</p>
<p>We define the cosine similarity for two arbitrary vectors as:</p>
<div style="text-align: center;">
<p><span class="math">Cosine similarity = \(\frac{u^Tv}{\lVert u \rVert \lVert v \rVert}\) </span></p>  
</div>
<p>The user-user similarity matrix can be computed as:</p>
<div style="text-align: center;">
<p><span class="math">User-user similarity = \( RR^T\) </span></p>  
</div>
<p>which produces a symmetric <span class = "math">\(m\times m\)</span> matrix, where <span class = "math">\(m\)</span> is the total number of users. The item-item similarity can be calculated in a similar way:</p>
<div style="text-align: center;">
<p><span class="math">Item-item similarity = \( R^TR\) </span></p>  
</div>
<p>which produces a symmetric <span class = "math">\(n\times n\)</span> matrix, where <span class = "math">\(n\)</span> is the total number of songs. </p>
<p><br></p>

<h3>Evaluation Metric</h3>
<p>We use the mean average precision (MAP) as the evaluation metric. </p>
<p>For any k, define the <i>precision-at-k</i> <span class = "math">\(P_k\)</span> as the proportion of correct recommendations within the top-<i>k</i> of the predicted ranking:</p>
<div style="text-align: center;">
<p><span class="math">\( P_k(u,y)=\frac{1}{k}\sum_{j=1}^kM_{u,y(j)}\), </span></p>  
</div>
<p>next we take the average of the computed precisions:</p>
<div style="text-align: center;">
<p><span class="math">\( AP(u,y)=\frac{1}{n_u}\sum_{k=1}^\tau P_k(u,y)\times M_{u,y_u(k)}\) </span></p> 
</div>
<p>where <span class = "math">\(\tau\)</span> is the threshold that represents how many of the top predictions in <span class = "math">\(y_u\)</span> to include and <span class = "math">\(n_u\)</span> is the number of songs in the users hidden history.</p>
<p>Finally, we take the average over all users precisions:</p>
<div style="text-align: center;">
<p><span class="math">\( MAP = \frac{1}{m}\sum_{u}AP(u,y_u)\) </span></p></div>
<p>The R functions for the evaluation metrics are shown below:</p>

<pre class = 'brush: python'>average_precision_at_k <- function(k, actual, predicted){
  score <- 0.0
  cnt <- 0.0
  for (i in 1:min(k,length(predicted)))
  {
    if (predicted[i] %in% actual && !(predicted[i] %in% predicted[0:(i-1)]))
    {
      cnt <- cnt + 1
      score <- score + cnt/i 
    }
  }
  score <- score / min(length(actual), k)
  return(score)
}

mAP = mean(average_precision_at_k(500, valid_data, predicted_songs))
</pre>
<p><br></p>
<h3>Strategy - Recommend top 500</h3>
<p>A simple strategy would be to suggest the same top 500 most played songs to all users.</p>
<p>To do this, first, we load in the relevant libraries, and construct the training and validtion datasets. For details on the initial loading of the data from the text files and SQLite databases the R code above.</p>
<pre class="brush: python">library(readr)
library(dplyr)
library(tidyr)
library(Matrix)
library(plyr)
library(pbapply)

# Load in data
triplets <- as.data.frame(read_table('data/kaggle/kaggle_visible_evaluation_triplets.txt'))
colnames(triplets) <- c('User_ID', 'Song_ID', 'Plays')

# Split data into train and validation set
set.seed(666) # reproducibility
train_data <- triplets %>%
  dplyr::group_by(User_ID) %>%
  dplyr::sample_frac(0.8) %>%
  dplyr::ungroup()

valid_data <- setdiff(triplets, train_data)</pre>
<p><br></p>
<p>The top 1000 songs are chosen based on total number number of plays across all users.</p>
<pre class="brush: python"># baseline is to recommend top n most played songs,
top1000songs <- train_data %>% 
  dplyr::group_by(Song_ID) %>%
  dplyr::summarise(Total.Plays = sum(Plays)) %>%
  dplyr::arrange(desc(Total.Plays)) %>%
  dplyr::top_n(1000) %>%
  dplyr::ungroup()

getBaseline_AveragePrecision(user){
  actual.songs <- filter(valid_data, User_ID == unique_users$User_ID[user])
  avg.Pres <- average_precision_at_k(k=500, actual = actual.songs$Song_ID, 
                                     predicted = top1000songs$Song_ID[1:500])
  return(avg.Pres)
}

mAP_baseline <- pbsapply(seq(nrow(multMat2)), getUser_Average_Precision)
</pre>
<p><br></p>
<h3>Strategy - Recommend songs by finding similar songs to songs in users list of listened songs</h3>
<p>Two songs are similar if they have many users in common that listen to both.</p>
<p>This is achieved in R by creating a sparse matrix, and performing the operations on the sparse matrix.</p>
<pre class="brush: python"><code># Create data frames of the unique songs and users
unique_users <- unique(train_data$User_ID)
unique_songs <- unique(train_data$Song_ID)

unique_users <- as.character(unique_users)
unique_songs <- as.character(unique_songs)

# Create new column where user/song ID -> unique numeric
unique_users <- cbind(unique_users, as.numeric(seq(nrow(as.data.frame(unique_users)))))
unique_songs <- cbind(unique_songs, as.numeric(seq(nrow(as.data.frame(unique_songs)))))

colnames(unique_users) <- c('User_ID', 'UID')
colnames(unique_songs) <- c('Song_ID', 'SID')

train_data$User_ID <- as.character(train_data$User_ID)
train_data$Song_ID <- as.character(train_data$Song_ID)

# Join datasets
train_data_2 <- train_data %>% 
  dplyr::left_join(as.data.frame(unique_users), by = 'User_ID') %>%
  dplyr::left_join(as.data.frame(unique_songs), by =  'Song_ID') %>%
  dplyr::group_by(User_ID) %>%
  dplyr::mutate(Relative.Plays = Plays/sum(Plays))

# remove all NAs
train_data_2[is.na(train_data_2)] <- 0 

# Create sparse matrix
sparse_rating_df <- sparseMatrix(i = as.numeric(train_data_2$UID), 
                                 j = as.numeric(train_data_2$SID), 
                                 x = train_data_2$Relative.Plays)</code></pre>
<p><br></p>
<p>The method used to recommend the songs will be to recommend songs that are similar to songs already in the users list of listened songs. This is shown using the Venn diagram below.</p>
<p><br></p>
<center><img src="figs/songSim.png" width="500" align="center"></center>
<p><br></p>
<p>The R code to achieve the item-item similarity is as follows:</p>
<pre class = 'brush: python'><code># Song similarity matrix
multMat1 <- t(sparse_rating_df) %*% (sparse_rating_df)

# Get top 500 similar songs of a given song
gettop500simSong <- function(song){
  user_sim <- multMat1[song,] 
  user_sim <- as.data.frame(cbind(user_sim, seq(length(user_sim))))
  colnames(user_sim) <- c('Similarity', 'SID')
  user_sim <- user_sim %>%
    dplyr::left_join(unique_songs, by = 'SID') %>%
    dplyr::arrange(desc(Similarity)) %>%
    dplyr::top_n(500, Similarity) 
  return(user_sim)
}

# Get average precision of user via song similarity
getSong_Average_Precision<- function(user){
  # Get the visible song in users song list 
  songs <- train_data_2 %>%
    filter(UID == user) %>%
    select(SID)
  
  # If SID is of factor class change to integer
  if (class(songs$SID) == "factor"){
    songs$SID <- as.integer(levels(songs$SID))[songs$SID]
  }

  # Go through songs and get 500 most similar songs
  top500total <- ldply(songs$SID, gettop500simSong) %>%
    anti_join(songs, by = 'SID') %>% # remove songs already in users song list
    distinct() %>%                   # remove duplicates
    arrange(desc(Similarity)) %>%    # order by similarity
    top_n(500, Similarity)           # take top 500
  
  # Get actual songs from validation datset
  actual.songs <- filter(valid_data, User_ID == unique_users$User_ID[user])

  # Calculate average precision
  avg.Pres <- average_precision_at_k(k=500, actual = actual.songs$Song_ID, predicted = top500total$Song_ID)
  return(avg.Pres)
}

mAP <- mean(pbsapply(seq(nrow(multMat1)), getSong_Average_Precision))</code></pre>
<p><br></p>
<h3>Strategy - Recommend songs by finding similar users and selecting songs in their list of listened songs </h3>
<p>Two users are similar if they have listened to many of the same songs. The user-user similarity is calculated in a similar way to the item-item similarity. After each users recommendations the songs are ordered in termes of total plays. The Venn diagram of the strategy is shown below.</p>
<p><br></p>
<center><img src="figs/userSim.png" width="500" align="middle"></center>
<p><br></p>
<p>The R code to achieve this is as follows:</p>
<pre class = 'brush: python'><code># User similarity matrix
multMat2 <- sparse_rating_df %*% t(sparse_rating_df)

# Function that recommends songs based on 2 users song list
recommend_by_user <- function(user1, user2){
  # Get song intersection of 2 users
  user1.songs <- train_data %>% 
    dplyr::filter(User_ID == user1) %>%
    dplyr::select(Song_ID, Plays)
  user2.songs <- train_data %>% 
    dplyr::filter(User_ID == user2) %>%
    dplyr::select(Song_ID, Plays)

  # Get songs in user2, that not in user1 
  recommend.songs <- dplyr::anti_join(user2.songs, user1.songs, 
                                      by = 'Song_ID') %>%
    dplyr::arrange(desc(Plays)) %>%  # sort by number of plays
    dplyr::select(-Plays)
  return(recommend.songs)
}

getUser_Average_Precision<- function(user){
  # Get top 100 unique users  
  user1_sim <- multMat2[user,] 
  user1_sim <- as.data.frame(cbind(user1_sim, seq(length(user1_sim))))
  colnames(user1_sim) <- c('Similarity', 'UID')
  user1_sim <- user1_sim %>%
    dplyr::arrange(desc(Similarity)) %>%
    dplyr::top_n(100, Similarity) %>%
    dplyr::left_join(unique_users, by = 'UID')
  
  # Initialsize empty data frame
  rec.songs <- data.frame()
  i = 1
  while(nrow(rec.songs) < 500){
    # Recommend songs if they have any songs in common (similarity > 0)
    if(user1_sim$Similarity[i] > 0.00000){
      new.songs <- recommend_by_user(user1_sim$User_ID[user], user1_sim$User_ID[i])
      rec.songs <- unique(rbind(rec.songs, new.songs))
    } 
    # otherwise choose from top 1000 songs
    else{
      new.songs <- as.data.frame(top1000songs$Song_ID[1:(1000-nrow(rec.songs))+1], 
                                 stringsAsFactors = FALSE)
      colnames(new.songs) <- 'Song_ID'
      rec.songs <- unique(rbind(rec.songs, new.songs))
    }
    i = i + 1
  }
  
  # Get actual songs from validation datset
  actual.songs <- filter(valid_data, User_ID == unique_users$User_ID[user])

  # Calculate averag precision
  avg.Pres <- average_precision_at_k(k=500, actual = actual.songs$Song_ID, predicted = rec.songs$Song_ID)
  return(avg.Pres)
}

mAP <- mean(pbsapply(seq(nrow(multMat2)), getUser_Average_Precision))</code></pre>
<p><br></p>

          					<div class="left">     	
              					<div class="container">
                					<div class="sideText3">
                  						<span class="line"></span>
                	  					<p></p>
                					</div>
              					</div>	   
								
         	 				</div>
      					</div>
    				</div>
				</article>
  				<!-- End Resolution 4 --> 
  
  				<!-- Resolution 5 --> 
    			<article id="five" style="background-color:#f7f7f7;">
      				<div class="center">      
      					<p><br></p>
          				<h2>Results</h2>
                  <p><br></p>
                  <p>In the results shown, <i>k</i>-fold cross validation is used, for <i>k</i>=5. The MAP for each of the strategies is shown below.</p>
                  <script>
                      var myChart_chordProg = new Chart({...})
                  </script>
                  <canvas id="myChart_chordProg" width="350" height="150"></canvas>
                  <script>
                  var ctx = document.getElementById("myChart_chordProg");
                  ctx.width = 200;
                  ctx.height = 100;
                  var randomColorFactor = function() {
                              return Math.round(Math.random() * 255);
                          };
                  var randomColor = function() {
                              return 'rgba(' + randomColorFactor() + ',' + randomColorFactor() + ',' + randomColorFactor() + ',.7)';
                          };
                  var myChart = new Chart(ctx, {
                      type: 'bar',
                      data: {
                          labels: ['Item/item', 'User/User', 'Baseline'],
                          datasets: [{
                              label: 'MAP',
                              data: [0.0482, 0.0412,0.0213],
                              backgroundColor: 'rgba(24, 188, 156, 0.6)',
                              borderColor: 'rgba(9, 74, 61, 1)',
                              borderWidth: 2
                          }]
                      },
                      options: {
                        title: {
                              display: true,
                              text: 'Mean Average Precision',
                              fontSize: 30
                          },
                          scales: {
                              yAxes: [{
                                  ticks: {
                                      beginAtZero:true
                                  },
                                  scaleLabel: {
                                display: true,
                                labelString: 'MAP at k=500',
                                fontSize: 30
                              }
                              }],
                              xAxes: [{
                                  scaleLabel: {
                                display: true,
                                labelString: 'Strategy',
                                fontSize: 30
                              }
                              }]
                          }
                      }
                  });
                  </script> 
                  <p><br></p>
                  <p>We can see that item/item similarity has the largest MAP score, slightly outperforming the user-user similarity strategy. In terms of run time, the base-line strategy is unsurprisingly the quickest, at around 0.72 seconds/user, followed by item-item similarity at around 4.23 seconds per user, and finally the user-user similarity was significantly slower at 121.2 seconds/user. This may be due to the user-user similarity matrix, while smaller than the item-item similarity (110000<sup>2</sup> vs 149029<sup>2</sup>), it is not as sparse, so sorting through the matrix, in looking for common users, as well as allocating memory is more expensive.</p>
                  <p><br></p>

          				
          				<div class="left">
							
                  				
          				</div>
          				<div class="right">
          				</div>
      				</div>
    			</article>
  				<!-- End Resolution 5 --> 

				<!-- Resolution 6 --> 
    			<article id="six">
      				<div class="center">  
						
<h2>Recommending Songs based on Metadata</h2>
<p><br></p>
<h3>Discovering new artists</h3>
<p>Since item/item similarity was gave the best results and was much quicker to process this is the stratey we will continue with, though the same recommendation methods can be used with the user/user similarity.</p>
<p>Since there are no correct answers, evaluation metrics are redundant, and A/B/n testing would be more appropriate.</p>
<p>To discover new artists we follow a similar method however in the top 500 similar artists we will order in the list in terms of artist ascending familiarity, and suggest those at the top first. The 'artist familiarity' corresponds to how well known in artist is. You can look at familiarity as the likelihood that any person selected at random will have heard of the artist. Kanye West has a familiarity close to 1, while a band like Hot Rod Shopping Cart has a familiarity close to zero. In this way songs are both similar to songs in the users lists of listened songs, and unlikely to be heard by the user.</p>
<p>This can be achieved using the R code below.</p>
<pre class = 'brush: python'><code>discoverNewSongs<- function(user){
  # Get users songs   
  usersongs <- train_data_2 %>%
    filter(UID == user) %>%
    select(SID)
  
  # If SID is of factor class change to integer
  if (class(usersongs$SID) == "factor"){
    usersongs$SID <- as.integer(levels(usersongs$SID))[usersongs$SID]
  }

  # Get top 500 similar songs for each song in user song list
  top500total <- ldply(usersongs$SID, gettop500simSong) %>% 
    dplyr::anti_join(usersongs, by = 'SID') %>%                 # remove songs already in song list
    dplyr::distinct() %>%                                       # remove duplicates
    dplyr::top_n(500, Similarity) %>%                           # take top 500 based on similarity
    dplyr::left_join(songs, by = c('Song_ID' = 'song_id')) %>%  # join with metadata dataset
    dplyr::arrange(artist_familiarity) %>%                      # sort based on artist familiarity
    dplyr::select(artist_name, title, artist_familiarity, Song_ID) 
  return(top500total)
}</code></pre>
<p><br></p>
<h4>Playlists to chillout/workout to</h4>
<p>Many songs from chillout playlists, such as those found on Spotify or last.fm have slow and easy-going, characterized by a low tempo that will relax the listener. Alternatively, if listeners want to get motivated to workout they may want listen to songs with high tempo that will get their heartrate up. This can be done with the following code:</p>
<pre class = 'brush: python'><code># Find songs with low tempo
downbeatSongs<- function(user){
  # Get users songs
  usersongs <- train_data_2 %>%
    filter(UID == user) %>%
    select(SID)
  
  # If SID is of factor class change to integer
  if (class(usersongs$SID) == "factor"){
    usersongs$SID <- as.integer(levels(usersongs$SID))[usersongs$SID]
  }

  # Get top 500 similar songs for each song in user song list
  top500total <- ldply(usersongs$SID, gettop500simSong) %>%                
    dplyr::distinct() %>%                                 # Remove duplicates
    dplyr::top_n(500, Similarity) %>%                     # get 500 most popular songs
    dplyr::left_join(song2track, by = 'Song_ID') %>%      # to convert song_id to trackid
    dplyr::left_join(song_metadata, by = c('Track_ID' = 'track_id')) %>% # join with metadata
    dplyr::arrange(tempo) %>%                             # order with respect to tempo
    dplyr::select(Song_ID, tempo) %>%                     # select releveant columns
    dplyr::filter(!is.na(Song_ID))                        # remove NAs
  return(top500total)
}

# Find songs with high tempo
upbeatSongs<- function(user){
  usersongs <- train_data_2 %>%
    filter(UID == user) %>%
    select(SID)
  
  # If SID is of factor class change to integer
  if (class(usersongs$SID) == "factor"){
    usersongs$SID <- as.integer(levels(usersongs$SID))[usersongs$SID]
  }

  # Get top 500 similar songs for each song in user song list
  top500total <- ldply(usersongs$SID, gettop500simSong) %>%
    dplyr::distinct() %>%                                 # Remove duplicates
    dplyr::top_n(500, Similarity) %>%                     # get 500 most popular songs
    dplyr::left_join(song2track, by = 'Song_ID') %>%      # to convert song_id to trackid, 
    dplyr::left_join(song_metadata, by = c('Track_ID' = 'track_id')) %>% # join with metadata
    dplyr::arrange(desc(tempo)) %>%                       # order with respect to tempo
    dplyr::select(Song_ID, tempo) %>%                     # select releveant columns
    dplyr::filter(!is.na(Song_ID))                        # remove NAs
  return(top500total)
}</code></pre>
<p><br></p>
<p>In this application it doesn't matter if the songs are already in the users list of listened songs, unlike for recommending new music.</p>
<p>This serves as a good template for A/B/n testing, creating indices based on a variety of metadata may also be used, for example a workout index may be defined as the <span class = 'math'>\(WI = \log(tempo\times danceability)\)</span>, where the danceabilty is defined from the <a target='_blank' href="https://developer.spotify.com/spotify-echo-nest-api/">Spotify/echonest API</a>. A/B testing can by varying the indices created, selecting songs based on the indices. The best index can be determined based on user feedback, such as number of plays, shares, or follows of the playlist. </p>
<p><br></p>

<p><br></p>

						
          				<div class="left">
            				<p></p> 
            				<div class="container">
               					<div class="sideText5">
                  					<span class="line"></span>
                	 				<p></p>
                				</div>
            				</div>	
      						<p></p>
        				</div>
          				<div class="right">
        				</div> 
       				</div>       
    			</article>
    			<!-- End Resolution 6 --> 

				<!-- Resolution 7 -->  
    			<article id="seven" style="/*background-color:#f7f7f7;*/ padding-bottom: 0;">	 
					<div class="center">
					   <div style="clear:both;"></div>	
      				</div>   	
    			</article>
  				<!-- End Resolution 7 --> 
  	
				<!-- Resolution 8 -->  
    			<article id="eight">
      				<div class="center">	
              			<h2>Conclusion</h2>
                    <p>Overall, a successful recommendation system is made and has been applied to create custom mood-based playlists ready for A/B/n testing. It is shown that recommendation system based on item-item gives the largest mean average precision for the dataset. All strategies can be combined with different weights, however this in unrealistic with a single machine. Other methods to recommend songs is to find the user-user and item-item similarity via singular value decomposition, as this is fast and efficient, yet has a tendency to overfit, without regularization.</p>
<p><br></p>
              			<div class="left"> 	
                			<div class="container">
                				<div class="sideText4">
                  					<span class="line"></span>
                		  			<p></p>
                				</div>
              				</div>	  
      						<p></p>
            			</div>
              			<div class="right">
              			</div>  
              			<div style="clear: both;"></div>
                     </div> 
              		 <div class="center">
              		</div>  	
    			</article>
  				<!-- End Resolution 8 --> 
	
    			<!-- Resolution 9-->      
    			<article id="forecast" style=" display: block; margin-bottom: 0px; ">
      					<div class="center"> 
              				<h2>Other Projects</h2>        
              				<p><br></p>
              				<p><big>For more similar projects check out my blog posts on <a href="/blog/Spark-Music-Rec/">predicting song listens with Apache Spark</a>, <a href="/blog/Ultimate-Playlist-Title/">what makes the ultimate playlist title</a>, and <a href="/blog/Two-Listeners/">the two types of music streamers</a>.</big></p>

              				<p><br></p>
              				<p><br></p>
              				<p><br></p>
              				<p><br></p>
              				<p><br></p>
              				<p><br></p>
              				<p class style="font-style: italic; margin-bottom: 33px;">
      					</div>
      				
    			</article>
    			<!-- End Resolution 9 --> 
              
        	</div> <!--extra wrapper-->
         	<footer class="text-center">
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <h4>Matthew Moocarme - moocarme@gmail.com</h4>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    	</div><!-- end wrapper -->
 	<script type="text/javascript" src="//munchkin.marketo.net//munchkin-beta.js"></script><script>Munchkin.init('062-HAC-076', {customName: 'past-forward-2016', wsInfo: 'j1RR'});</script>
 	</body>


<style>
#mktoForm_375 {
    width: auto!important;
}
</style>
<script type="text/javascript">
     SyntaxHighlighter.all()
</script>
<script>
$(document).ready(function() {
  
    
  
	var sections = $('article'), 
        nav = $('nav'), 
        nav_height = nav.outerHeight();
 
	$(window).on('scroll', function () {

  		var cur_pos = $(this).scrollTop();
 
  		sections.each(function() {
    	var top = $(this).offset().top - nav_height,
        bottom = top + $(this).outerHeight();
 
    	if (cur_pos >= top && cur_pos <= bottom) {
      		nav.find('a').removeClass('active');
      		sections.removeClass('active');
 
      		$(this).addClass('active');
      		nav.find('a[href="/examples/SmoothPageScroll/#'+$(this).attr('id')+'"]').addClass('active');
    	}
  		});
      
      	if ($('#one .left').isOnScreen()) {
    		var wScroll = $(this).scrollTop();
          	var $sideText1 = $('.sideText1');
            var containerScroll = wScroll - $sideText1.parent().offset().top + 1000;
      		$sideText1.css({
       			'transform' : 'translate(0px, +'+ containerScroll/10 +'%)' 
      		});  
      	}
      	
      	if ($('#two .left').isOnScreen()) {
    		var wScroll = $(this).scrollTop();
          	var $sideText2 = $('.sideText2');
          	var containerScroll2 = wScroll - $sideText2.parent().offset().top + 1000;
      		$sideText2.css({
       			'transform' : 'translate(0px, +'+ containerScroll2/10 +'%)' 
      		});  
      	}
      	
      	 if ($('#four .left').isOnScreen()) {
    		var wScroll = $(this).scrollTop();
          	var $sideText3 = $('.sideText3');
          	var containerScroll3 = wScroll - $sideText3.parent().offset().top + 1000;
      		$sideText3.css({
       			'transform' : 'translate(0px, +'+ containerScroll3/10 +'%)' 
      		});  
      	}
      
      	if ($('#eight .left').isOnScreen()) {
    		var wScroll = $(this).scrollTop();
          	var $sideText4 = $('.sideText4');
          	var containerScroll4 = wScroll - $sideText4.parent().offset().top + 1000;
      		$sideText4.css({
       			'transform' : 'translate(0px, +'+ containerScroll4/10 +'%)' 
      		});  
      	}
      
      	if ($('#six .left').isOnScreen()) {
    		var wScroll = $(this).scrollTop();
          	var $sideText5 = $('.sideText5');
          	var containerScroll5 = wScroll - $sideText5.parent().offset().top + 1000;
      		$sideText5.css({
       			'transform' : 'translate(0px, +'+ containerScroll5/10 +'%)' 
      		});  
      	}
      
      	/** Measures the height of hero then nav bar appears after it **/
      	var heroHeight = $('.hero').height();
      
      	if ($(this).scrollTop() > heroHeight) {
          $('.nav-toggle').addClass('show');
        } else {
           $('.nav-toggle').removeClass('show');
        }

      	/** For Desktop Nav only (from 1170px wide) **/
      	if ($(this).scrollTop() > heroHeight){ 
    		$('#desktopNav').addClass('fixedElement'); 
  		} else {
    		$('#desktopNav').removeClass('fixedElement'); 
  		}	
	});  
  
  	/**** Smooth Scrolling ****/
	$('a[href*=#]:not([href=#])').click(function() {
    	if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') 
        	|| location.hostname == this.hostname) {

        	var target = $(this.hash);
        	target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
           	if (target.length) {
            	$('html,body').animate({
                	scrollTop: target.offset().top
            	}, 1000);
            	return false;
        	}
    	}
	});
  	
  	
}); 

  
  /*** Navigation menu toggle ***/
  $('.nav-toggle').on('click', function(){
    $('.wrapper').toggleClass('open');
    $('.main-navigation-left').toggleClass('open');
    $('.nav-toggle').toggleClass('open');
  });
  
  /*Desktop Fixed Nav*/
  var stickyTop = $('#desktopNav').offset().top;
  
  
  /** Function to see when a div is in view **/
  $.fn.isOnScreen = function(){
    var win = $(window);
    var viewport = {
        top : win.scrollTop(),
        left : win.scrollLeft()
    };
    
    viewport.right = viewport.left + win.width();
    viewport.bottom = viewport.top + win.height();
    
    var bounds = this.offset();
    bounds.right = bounds.left + this.outerWidth();
    bounds.bottom = bounds.top + this.outerHeight();
    
    return (!(viewport.right < bounds.left || viewport.left > bounds.right || viewport.bottom < bounds.top || viewport.top > bounds.bottom));
  };
</script></html>
