<p>Here, the objective is to compare the speed and ease of use with either R or python to selct, tidy, and analyse medium sized datasets. The dataset that I will be using is the ‘Earth Surface Temperature Data’ available from <a href="https://www.kaggle.com/berkeleyearth/climate-change-earth-surface-temperature-data">Kaggle</a>, which combines 1.6 billion temperature reports from various datasets such as NOAA’s MLOST, NASA’s GISTEMP and the UK’s HadCrut. All temperatures are in units of (^oC) and the dataset is roughly 533Mb.</p>

<p>This dataset will be used to see if there is any trend between the yearly average temperature in New York City and the year. First statistical significance between the two variables will be shown, which can be achieved using a p-value test. Following, the trend can be visualized, by plotting the two variables with a trend line determined via linear regression.</p>

<p>In comparing R and Python I am interested in determining the ease of use to clean, tidy and slice the data according the problem I am trying to solve. Clean and tidy data takes the form of one row per observation and one column per variable.</p>

<h2 id="r">R</h2>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">readr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">city_temp</span> <span class="o">&lt;-</span> <span class="n">read_csv</span><span class="p">(</span><span class="s1">'data/GlobalLandTemperaturesByCity.csv'</span><span class="p">)</span>
<span class="n">city_temp_US</span> <span class="o">&lt;-</span> <span class="n">city_temp</span> <span class="o">%&gt;%</span> 
  <span class="n">filter</span><span class="p">(</span><span class="n">Country</span> <span class="o">==</span> <span class="s1">'United States'</span> <span class="o">&amp;</span> <span class="n">City</span> <span class="o">==</span> <span class="s1">'New York'</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">Country</span><span class="p">,</span> <span class="o">-</span><span class="n">Latitude</span><span class="p">,</span> <span class="o">-</span><span class="n">Longitude</span><span class="p">,</span> <span class="o">-</span><span class="n">City</span><span class="p">,</span> <span class="o">-</span><span class="n">AverageTemperatureUncertainty</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="n">mutate</span><span class="p">(</span><span class="n">the.year</span> <span class="o">=</span> <span class="n">year</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="n">group_by</span><span class="p">(</span><span class="n">the.year</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="n">summarise</span><span class="p">(</span><span class="n">Average.Temp</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">AverageTemperature</span><span class="p">))</span>
</code></pre>
</div>

<p>Now the data is clean and tidy we can perform a T-test to determine statistical significance.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">t.test</span><span class="p">(</span> <span class="n">city_temp_US</span><span class="o">$</span><span class="n">Average.Temp</span><span class="p">,</span> <span class="n">city_temp_US</span><span class="o">$</span><span class="n">the.year</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>    Welch Two Sample t-test

data:  city_temp_US$Average.Temp and city_temp_US$the.year
t = -392.42, df = 270.06, p-value &lt; 2.2e-16
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -1877.788 -1859.040
sample estimates:
  mean of x   mean of y 
   9.585955 1878.000000 
</code></pre>
</div>

<p>The p-value is less that 0.05 so there is statistical significance between the two variables. Now we can plot the two, perfom linear refgression, and add a trend line.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">city_temp_US</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">the.year</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Average.Temp</span><span class="p">))</span> <span class="o">+</span> 
  <span class="n">geom_point</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span> <span class="n">color</span> <span class="o">=</span> <span class="n">Average.Temp</span><span class="p">))</span><span class="o">+</span> <span class="n">geom_smooth</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">lm</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">scale_color_gradient</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="s1">'red'</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span> <span class="s1">'yellow'</span><span class="p">)</span> <span class="o">+</span>
  <span class="n">ggtitle</span><span class="p">(</span><span class="s1">'New York City Average Yearly Temperature from 1743 to 2013'</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="R-Vs-Python-Linear-Regression_files/figure-markdown_github/plot-1.png" alt="" /></p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">lmfit</span> <span class="o">&lt;-</span> <span class="n">lm</span><span class="p">(</span><span class="n">city_temp_US</span><span class="o">$</span><span class="n">Average.Temp</span> <span class="o">~</span> <span class="n">city_temp_US</span><span class="o">$</span><span class="n">the.year</span><span class="p">)</span>
<span class="n">lmfit</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Call:
lm(formula = city_temp_US$Average.Temp ~ city_temp_US$the.year)

Coefficients:
          (Intercept)  city_temp_US$the.year  
             -1.98404                0.00612  
</code></pre>
</div>

<p>From the plot and linear model fit we can see that there is a positive trend between the year and the average temperature in New York City. Specifically it shows that there is 0.00612(^oC/year) increase in the temperature since 1743.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>   user  system elapsed 
 29.462   1.169  30.694 
</code></pre>
</div>

<p>The total time elapsed from the running of the code was 12.394 seconds. Where most of this time was due to the inital loading in of the data.</p>

<h2 id="python">Python</h2>

<p>Now we repeat the same analysis in Python. In similar steps, the appropriate libraries are imported, the data is loaded into memory, cleaned and tidyed. Following, regression techniques are used to determine statistical significance.</p>

<p>Here least squares regression is equivalent to R’s linear model fit. Thiel-Sen regression is also included to obtain confidence intervals.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c"># Start timer</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c"># Load in csv file</span>
<span class="n">city_data_py</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/GlobalLandTemperaturesByCity.csv'</span><span class="p">)</span> 

<span class="c"># Filter for city equal to 'New York'</span>
<span class="n">city_data_US_py</span> <span class="o">=</span> <span class="n">city_data_py</span><span class="p">[</span><span class="n">city_data_py</span><span class="p">[</span><span class="s">'City'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'New York'</span><span class="p">]</span>

<span class="c"># Filter for country equal to 'United States' </span>
<span class="n">city_data_US_py</span> <span class="o">=</span> <span class="n">city_data_US_py</span><span class="p">[</span><span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'Country'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'United States'</span><span class="p">]</span>  

<span class="c"># Select only 'datetime' and 'AverageTemperature' columns</span>
<span class="n">city_data_US_py</span> <span class="o">=</span> <span class="n">city_data_US_py</span> <span class="p">[[</span><span class="s">'dt'</span><span class="p">,</span> <span class="s">'AverageTemperature'</span><span class="p">]]</span>

<span class="c"># Remove NaN values</span>
<span class="n">city_data_US_py</span> <span class="o">=</span> <span class="n">city_data_US_py</span><span class="p">[</span><span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'AverageTemperature'</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

<span class="c"># Convert datetime column to a pandas datetime series object </span>
<span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'dt'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'dt'</span><span class="p">]))</span>

<span class="c"># Make new column as the year of the dt column</span>
<span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'year'</span><span class="p">]</span> <span class="o">=</span> <span class="n">city_data_US_py</span><span class="p">[</span><span class="s">'dt'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

<span class="c"># Group by year and take the mean</span>
<span class="n">AvgTemp_US_py</span> <span class="o">=</span> <span class="n">city_data_US_py</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'year'</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c"># Create new column of the year</span>
<span class="n">AvgTemp_US_py</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">'Year'</span>
<span class="n">AvgTemp_US_py</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Use scipy lingress function to perform linear regression</span>
<span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> \
    <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'AverageTemperature'</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">'The p-value between the 2 variables is measured as '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_value</span><span class="p">)</span> <span class="o">+</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Least squares linear model coefficients, intercept = '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span> <span class="o">+</span> \
  <span class="s">'. Slope = '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span><span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="c"># Create regression line</span>
<span class="n">regressLine</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">]</span><span class="o">*</span><span class="n">slope</span>

<span class="c"># Regression using Theil-Sen with 95% confidence intervals </span>
<span class="n">res</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">theilslopes</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'AverageTemperature'</span><span class="p">],</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="mf">0.95</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Thiel-Sen linear model coefficients, intercept = '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s">'. Slope = '</span> <span class="o">+</span> \
  <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="c"># Scatter plot the temperature</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'AverageTemperature'</span><span class="p">],</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Average Teamperature'</span><span class="p">)</span>

<span class="c"># Add least squares regression line</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="n">regressLine</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Least squares regression line'</span><span class="p">);</span> 

<span class="c"># Add Theil-Sen regression line</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="s">'r-'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Theil-Sen regression line'</span><span class="p">)</span>

<span class="c"># Add Theil-Sen confidence intervals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="s">'r--'</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Theil-Sen 95</span><span class="si">% </span><span class="s">confidence interval'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">AvgTemp_US_py</span><span class="p">[</span><span class="s">'Year'</span><span class="p">],</span> <span class="s">'r--'</span><span class="p">)</span>

<span class="c"># Add legend, axis limits and save to png</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s">'upper left'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">14</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1755</span><span class="p">,</span> <span class="mi">2016</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Year'</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Temperature (C)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'pythonRegress.png'</span><span class="p">)</span>

<span class="c"># End timer</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Elapsed time = '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">+</span> <span class="s">' seconds'</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>The p-value between the 2 variables is measured as 3.69673779862e-16

Least squares linear model coefficients, intercept = -5.1924698547. Slope = 0.00778197442636

Thiel-Sen linear model coefficients, intercept = -1.37949751082. Slope = 0.00580735930736

Elapsed time = 9.93399000168 seconds
</code></pre>
</div>

<p>The p-value is again much less that 0.05, so there is statistical significance between the two variables.</p>

<p>We can see that the Thiel-Sen regression model most closely fits R’s linear regression model.</p>

<p>The total elapsed time is about 25% faster for python though. For larger datasets this could a much larger difference in terms of run time. <img src="pythonRegress.png" alt="" /></p>

<p>From the plot we can see that although the slopes and intercepts the different regression lines were quite difference in the range of years for which the data is provided both do an appropriate job in applying a trend to the data.</p>

<h3 id="discussion">Discussion</h3>

<p>When it comes to loading in the data to memory, pandas’ <em>read_csv</em> python function outperformed readr’s <em>read_csv</em> function. However in cleaning and tidying the data R’s <em>dplyr</em> and <em>tidyr</em> package make things easy and intuitive. Also the lubridate package makes working with datetime objects easier than the equivalent pandas functions.</p>

<p>With regards to plotting both were relatively easy to plot. R was a little easier to add the linear regression line with confidence intervals. R’s ggplot looks much better however, so in terms of plotting, R rules.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Altogether, comparing R and Python for linear regression, both languages have their strengths and weaknesses. Python has superior speed, though R’s ease of use has it’s clear advantages, especially when using the dplyr package for data cleaning. It may well be the case that the trade-off for easy impletation is run-speed.</p>

<p>What may be beneficial for future analyses is to do quick preliminary selecting and filtering of the data to reduce the overall size in python before doing a more comprehensive cleaning and analysis in R.</p>
